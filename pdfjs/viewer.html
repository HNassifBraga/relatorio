<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Relatório em PDF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" />
    <style>
      body { margin: 0; overflow: hidden; }
      #viewerContainer { width: 100vw; height: 100vh; overflow: auto; }
    </style>
  </head>
  <body>
    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>

    <script>
      const params = new URLSearchParams(window.location.search);
      const fileUrl = params.get("file");
      const pixelId = params.get("pixel_id");

      let currentPage = 1;
      let pageEnterTime = Date.now();

      // Tracking: tempo total na página
      window.addEventListener("beforeunload", () => {
        const elapsed = Math.floor((Date.now() - pageEnterTime) / 1000);
        fetch("https://primorainc.app.n8n.cloud/webhook/pixel-tracking", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            pixel_id: pixelId,
            file_url: fileUrl,
            tempo_total: elapsed
          })
        });
      });

      // Setup PDF.js
      const CMAP_URL = "https://unpkg.com/pdfjs-dist@3.11.174/cmaps/";
      const CMAP_PACKED = true;

      const eventBus = new pdfjsViewer.EventBus();
      const pdfLinkService = new pdfjsViewer.PDFLinkService({ eventBus });
      const pdfViewer = new pdfjsViewer.PDFViewer({
        container: document.getElementById("viewerContainer"),
        eventBus,
        linkService: pdfLinkService
      });

      pdfLinkService.setViewer(pdfViewer);

      eventBus.on("pagesinit", () => {
        pdfViewer.currentScaleValue = "page-width";
      });

      eventBus.on("pagechanging", (e) => {
        const now = Date.now();
        const timeSpent = Math.floor((now - pageEnterTime) / 1000);
        fetch("https://primorainc.app.n8n.cloud/webhook/pdf-page", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            pixel_id: pixelId,
            file_url: fileUrl,
            pagina: currentPage,
            tempo_em_segundos: timeSpent
          })
        });
        currentPage = e.pageNumber;
        pageEnterTime = now;
      });

      if (fileUrl) {
        const loadingTask = pdfjsLib.getDocument({
          url: fileUrl,
          cMapUrl: CMAP_URL,
          cMapPacked: CMAP_PACKED
        });
        loadingTask.promise.then(pdfDoc => {
          pdfViewer.setDocument(pdfDoc);
          pdfLinkService.setDocument(pdfDoc, null);
        });
      }
    </script>
  </body>
</html>
